<div class="flex flex-column gap-4">
  <div class="flex align-items-center gap-2">
    <a [routerLink]="[patientsBase]" class="back-link flex align-items-center gap-1 no-underline text-600 hover:text-900">
      <i class="pi pi-arrow-left"></i> Back to list
    </a>
  </div>
  @if (loadingPatient) {
    <div class="flex align-items-center justify-content-center py-8">
      <i class="pi pi-spin pi-spinner text-4xl text-primary"></i>
    </div>
  } @else {
  @if (isEditMode && recordSummary) {
    <p-card header="Records (VIS_A / VIS_B)" styleClass="shadow-2 border-round-lg mb-3 card-header-plain">
      <div class="flex flex-wrap gap-3 align-items-center">
        <span class="font-medium text-900">VIS_A: {{ recordSummary.visACount }}</span>
        <span class="font-medium text-900">VIS_B: {{ recordSummary.visBCount }}</span>
        <span class="text-600">|</span>
        @for (type of ['diagnosis', 'medication', 'note', 'lab', 'report', 'attachment']; track type) {
          @if (recordSummary.byType[type] > 0) {
            <span class="text-600">{{ type }}: {{ recordSummary.byType[type] }}</span>
          }
        }
      </div>
    </p-card>
  }
  <p-card [header]="isEditMode ? 'Edit Patient' : 'Register Patient'" styleClass="shadow-2 border-round-lg card-header-plain">
    <form (ngSubmit)="onSubmit()" class="flex flex-column gap-3">
      <div class="grid">
        <div class="col-12 md:col-6 flex flex-column gap-2">
          <label for="firstName" class="font-medium text-900">First name *</label>
          <input id="firstName" pInputText type="text" [(ngModel)]="firstName" name="firstName" required class="w-full" />
        </div>
        <div class="col-12 md:col-6 flex flex-column gap-2">
          <label for="lastName" class="font-medium text-900">Last name *</label>
          <input id="lastName" pInputText type="text" [(ngModel)]="lastName" name="lastName" required class="w-full" />
        </div>
      </div>
      <div class="grid">
        <div class="col-12 md:col-6 flex flex-column gap-2">
          <label for="dob" class="font-medium text-900">Date of birth *</label>
          <input id="dob" pInputText type="date" [(ngModel)]="dob" name="dob" required class="w-full" />
        </div>
        <div class="col-12 md:col-6 flex flex-column gap-2">
          <label for="gender" class="font-medium text-900">Gender</label>
          <p-select id="gender" [(ngModel)]="gender" name="gender" [options]="genderOptions" optionLabel="label" optionValue="value" placeholder="—" styleClass="w-full" />
        </div>
      </div>
      <div class="grid">
        <div class="col-12 md:col-6 flex flex-column gap-2">
          <label for="contactEmail" class="font-medium text-900">Contact email</label>
          <input id="contactEmail" pInputText type="email" [(ngModel)]="contactEmail" name="contactEmail" class="w-full" />
        </div>
        <div class="col-12 md:col-6 flex flex-column gap-2">
          <label for="contactPhone" class="font-medium text-900">Contact phone</label>
          <input id="contactPhone" pInputText type="text" [(ngModel)]="contactPhone" name="contactPhone" class="w-full" />
        </div>
      </div>
      <div class="flex flex-column gap-2">
        <label for="address" class="font-medium text-900">Address</label>
        <input id="address" pInputText type="text" [(ngModel)]="address" name="address" class="w-full" />
      </div>
      <div class="flex flex-column gap-2">
        <label for="doctor" class="font-medium text-900">Assign doctor *</label>
        <p-select id="doctor" [(ngModel)]="primaryDoctorId" name="primaryDoctorId" [options]="doctors" optionLabel="name" optionValue="_id" placeholder="Select doctor" styleClass="w-full" required />
      </div>
      <div class="flex flex-column gap-2">
        <label class="font-medium text-900">Default record visibility</label>
        <p-select [(ngModel)]="patientVisibility" name="patientVisibility" [options]="visibilityOptions" optionLabel="label" optionValue="value" styleClass="w-full" placeholder="VIS_A" />
      </div>
      @if (error) {
        <p-message severity="error" [text]="error" styleClass="w-full"></p-message>
      }
      <div class="flex gap-2">
        <p-button type="submit" [label]="loading ? 'Saving…' : (isEditMode ? 'Save changes' : 'Register Patient')" icon="pi pi-check" [loading]="loading" [disabled]="loading" />
        <a [routerLink]="isEditMode ? [patientsBase, patientId] : [patientsBase]" class="no-underline"><p-button type="button" label="Cancel" icon="pi pi-times" severity="secondary" styleClass="p-button-outlined"></p-button></a>
      </div>
    </form>
  </p-card>
  }
</div>
