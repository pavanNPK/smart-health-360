<div class="flex flex-column gap-4">
  <h1 class="m-0 text-2xl font-semibold text-900">
    <i class="pi pi-history mr-2 page-heading-icon"></i>Audit Logs
  </h1>
  <p-card styleClass="shadow-2 border-round-lg">
    @if (loading) {
      <div class="flex align-items-center justify-content-center py-8">
        <i class="pi pi-spin pi-spinner text-4xl text-primary"></i>
      </div>
    } @else {
      <p-table [value]="logs" styleClass="p-datatable-sm p-datatable-striped" [tableStyle]="{ 'min-width': '50rem' }" showGridlines>
        <ng-template pTemplate="header">
          <tr>
            <th>Time</th>
            <th>Action</th>
            <th>User</th>
            <th>Details</th>
            <th style="width: 6rem;">Actions</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-log>
          <tr>
            <td>{{ log.createdAt | date : 'short' }}</td>
            <td>{{ log.action }}</td>
            <td>{{ log.userId.name }} ({{ log.userId.email }})</td>
            <td><code class="text-sm surface-200 px-2 py-1 border-round">{{ log.details | json }}</code></td>
            <td>
              <p-button icon="pi pi-eye" label="View" styleClass="p-button-text p-button-sm" (onClick)="viewDetails(log)"></p-button>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="5" class="text-center py-4 text-600">No audit logs.</td>
          </tr>
        </ng-template>
      </p-table>
      <p class="text-600 text-sm mt-2">Page {{ page }} Â· {{ total }} total</p>
    }
  </p-card>
</div>

<p-dialog [(visible)]="showDetailsDialog" header="Audit log details" [modal]="true" [style]="{ width: '28rem' }" [draggable]="false" [resizable]="false" (onHide)="selectedLog = null">
  @if (selectedLog) {
    <div class="flex flex-column gap-2 text-sm">
      <div><span class="font-semibold text-700">Time:</span> {{ selectedLog.createdAt | date : 'medium' }}</div>
      <div><span class="font-semibold text-700">Action:</span> {{ selectedLog.action }}</div>
      <div><span class="font-semibold text-700">User:</span> {{ selectedLog.userId.name }} ({{ selectedLog.userId.email }})</div>
      @if (selectedLog && hasDetails(selectedLog)) {
        <div><span class="font-semibold text-700">Details:</span></div>
        <pre class="surface-100 p-2 border-round text-xs overflow-auto m-0" style="max-height: 12rem;">{{ selectedLog.details | json }}</pre>
      }
    </div>
  }
  <ng-template pTemplate="footer">
    <p-button label="Close" severity="secondary" (onClick)="showDetailsDialog = false; selectedLog = null"></p-button>
  </ng-template>
</p-dialog>
