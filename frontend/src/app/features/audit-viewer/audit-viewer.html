<div class="flex flex-column gap-4">
  <h1 class="m-0 text-2xl font-semibold text-900">
    <i class="pi pi-history mr-2 page-heading-icon"></i>Audit Logs
  </h1>
  <p-card styleClass="shadow-2 border-round-lg">
    <div class="flex flex-wrap align-items-center gap-2 mb-3">
      <label class="text-700 font-medium">Action:</label>
      <p-select
        [ngModel]="actionFilter"
        (ngModelChange)="actionFilter = $event; first = 0; page = 1; load()"
        [options]="actionOptions"
        optionLabel="label"
        optionValue="value"
        styleClass="w-12rem"
        placeholder="All actions"
      ></p-select>
      <p-button icon="pi pi-refresh" styleClass="p-button-outlined" (onClick)="load()" pTooltip="Refresh"></p-button>
    </div>
    <p-table
      [value]="logs"
      [lazy]="true"
      (onLazyLoad)="onLazyLoad($event)"
      [loading]="loading"
      [paginator]="true"
      [rows]="limit"
      [first]="first"
      [totalRecords]="total"
      [rowsPerPageOptions]="[10, 20, 50, 100]"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {{ first + 1 }} to {{ last }} of {{ total }} logs"
      styleClass="p-datatable-sm p-datatable-striped"
      [tableStyle]="{ 'min-width': '50rem' }"
      showGridlines
    >
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 4rem;">S.No</th>
            <th>Time</th>
            <th>Action</th>
            <th>Request</th>
            <th>User</th>
            <th>Details</th>
            <th style="width: 6rem;">Actions</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-log let-rowIndex="rowIndex">
          <tr>
            <td>{{ first + rowIndex + 1 }}</td>
            <td>{{ log.createdAt | date : 'short' }}</td>
            <td>{{ log.action }}</td>
            <td>
              @if (log.action === 'API_ACCESS' && log.details && log.details['method'] && log.details['path']) {
                <code class="text-sm surface-200 px-2 py-1 border-round">{{ log.details['method'] }} {{ log.details['path'] }}</code>
                <span class="text-500 ml-1">({{ log.details['statusCode'] }})</span>
              } @else {
                <span class="text-500">â€”</span>
              }
            </td>
            <td>{{ log.userId.name }} ({{ log.userId.email }})</td>
            <td><code class="text-sm surface-200 px-2 py-1 border-round">{{ log.details | json }}</code></td>
            <td>
              <p-button icon="pi pi-eye" styleClass="p-button-text p-button-sm" pTooltip="View" (onClick)="viewDetails(log)"></p-button>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="7" class="text-center py-4 text-600">No audit logs.</td>
          </tr>
        </ng-template>
    </p-table>
  </p-card>
</div>

<p-dialog [(visible)]="showDetailsDialog" header="Audit log details" [modal]="true" [style]="{ width: '28rem' }" [draggable]="false" [resizable]="false" (onHide)="selectedLog = null">
  @if (selectedLog) {
    <div class="flex flex-column gap-2 text-sm">
      <div><span class="font-semibold text-700">Time:</span> {{ selectedLog.createdAt | date : 'medium' }}</div>
      <div><span class="font-semibold text-700">Action:</span> {{ selectedLog.action }}</div>
      <div><span class="font-semibold text-700">User:</span> {{ selectedLog.userId.name }} ({{ selectedLog.userId.email }})</div>
      @if (selectedLog && hasDetails(selectedLog)) {
        <div><span class="font-semibold text-700">Details:</span></div>
        <pre class="surface-100 p-2 border-round text-xs overflow-auto m-0" style="max-height: 12rem;">{{ selectedLog.details | json }}</pre>
      }
    </div>
  }
  <ng-template pTemplate="footer">
    <p-button label="Close" severity="secondary" (onClick)="showDetailsDialog = false; selectedLog = null"></p-button>
  </ng-template>
</p-dialog>
