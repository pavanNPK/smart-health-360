<div class="flex flex-column gap-4">
  <div class="flex flex-wrap align-items-center justify-content-between gap-3">
    <h1 class="m-0 text-2xl font-semibold text-900">
      <i class="pi pi-id-card mr-2 page-heading-icon"></i>User Management
    </h1>
    <p-button label="Create User" icon="pi pi-plus" (onClick)="openForm()"></p-button>
  </div>
  @if (successMessage) {
    <p-message severity="success" [text]="successMessage + ' They must go to Verify email to set password and log in.'" styleClass="w-full"></p-message>
  }
  <p-card styleClass="shadow-2 border-round-lg">
    <p-table
      [value]="users"
      [lazy]="true"
      (onLazyLoad)="onLazyLoad($event)"
      [loading]="loading"
      [paginator]="true"
      [rows]="limit"
      [first]="first"
      [totalRecords]="total"
      [rowsPerPageOptions]="[10, 25, 50]"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {{ first + 1 }} to {{ last }} of {{ total }} users"
      styleClass="p-datatable-sm p-datatable-striped"
      [tableStyle]="tableStyle"
      showGridlines
    >
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 4rem;">S.No</th>
            <th>Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Clinic</th>
            <th>Status</th>
            <th>Specialization</th>
            <th style="width: 10rem;">Actions</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-u let-rowIndex="rowIndex">
          <tr>
            <td>{{ (page - 1) * limit + rowIndex + 1 }}</td>
            <td>{{ u.name }}</td>
            <td>{{ u.email }}</td>
            <td>{{ u.role }}</td>
            <td>{{ getClinicName(u) }}</td>
            <td>
              <span [class]="u.status === 'ACTIVE' ? 'text-green-600' : 'text-orange-600'">{{ u.status }}</span>
            </td>
            <td>{{ u.specialization || '—' }}</td>
            <td>
              <div class="flex gap-1 align-items-center">
                <p-button icon="pi pi-pencil" styleClass="p-button-text p-button-sm" pTooltip="Edit" (onClick)="openEditForm(u)"></p-button>
                @if (u.status === 'PENDING_VERIFICATION') {
                  <p-button icon="pi pi-envelope" styleClass="p-button-text p-button-sm" pTooltip="Resend OTP" (onClick)="resendOtp(u.email)"></p-button>
                }
                <p-button icon="pi pi-trash" styleClass="p-button-text p-button-sm p-button-danger" (onClick)="confirmDelete(u)" pTooltip="Delete"></p-button>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="8" class="text-center py-4 text-600">No users.</td>
          </tr>
        </ng-template>
    </p-table>
  </p-card>
</div>

<p-dialog [(visible)]="showForm" header="New User" [modal]="true" [style]="{ width: '28rem' }" [draggable]="false" [resizable]="false" (onHide)="showForm = false" [contentStyle]="{ overflow: 'visible' }">
  <form (ngSubmit)="createUser()" class="flex flex-column gap-3">
    <div class="flex flex-column gap-2">
      <label for="um-name" class="font-medium text-900">Name *</label>
      <input id="um-name" pInputText type="text" [(ngModel)]="form.name" name="name" required class="w-full" />
    </div>
    <div class="flex flex-column gap-2">
      <label for="um-email" class="font-medium text-900">Email *</label>
      <input id="um-email" pInputText type="email" [(ngModel)]="form.email" name="email" required class="w-full" />
    </div>
    <p class="text-600 text-sm m-0">Leave password blank to send OTP – user will verify email and set their own password.</p>
    <div class="flex flex-column gap-2">
      <label for="um-password" class="font-medium text-900">Password (optional)</label>
      <input id="um-password" pInputText type="password" [(ngModel)]="form.password" name="password" placeholder="Leave blank for OTP verification" class="w-full" />
    </div>
    <div class="flex flex-column gap-2">
      <label for="um-role" class="font-medium text-900">Role *</label>
      <p-select id="um-role" [(ngModel)]="form.role" name="role" [options]="roleOptions" optionLabel="label" optionValue="value" styleClass="w-full" appendTo="body" />
    </div>
    @if (form.role === 'DOCTOR' || form.role === 'RECEPTIONIST') {
      <div class="flex flex-column gap-2">
        <label for="um-clinic" class="font-medium text-900">Clinic *</label>
        <p-select id="um-clinic" [(ngModel)]="form.clinicId" name="clinicId" [options]="clinics" optionLabel="name" optionValue="_id" placeholder="Select clinic" styleClass="w-full" appendTo="body" />
      </div>
    }
    @if (form.role === 'DOCTOR') {
      <div class="flex flex-column gap-2">
        <label for="um-spec" class="font-medium text-900">Specialization (for Doctor)</label>
        <input id="um-spec" pInputText type="text" [(ngModel)]="form.specialization" name="specialization" class="w-full" />
      </div>
    }
    @if (error) {
      <p-message severity="error" [text]="error" styleClass="w-full"></p-message>
    }
  </form>
  <ng-template pTemplate="footer">
    <p-button label="Cancel" severity="secondary" (onClick)="showForm = false" styleClass="p-button-outlined" [disabled]="formSubmitting"></p-button>
    <p-button label="Create" icon="pi pi-check" (onClick)="createUser()" [loading]="formSubmitting" [disabled]="formSubmitting"></p-button>
  </ng-template>
</p-dialog>

<p-dialog [(visible)]="showEditForm" header="Edit User" [modal]="true" [style]="{ width: '28rem' }" [draggable]="false" [resizable]="false" (onHide)="showEditForm = false" [contentStyle]="{ overflow: 'visible' }">
  @if (editingUser) {
    <form (ngSubmit)="updateUser()" class="flex flex-column gap-3">
      <div class="flex flex-column gap-2">
        <label for="edit-name" class="font-medium text-900">Name *</label>
        <input id="edit-name" pInputText type="text" [(ngModel)]="editForm.name" name="editName" required class="w-full" />
      </div>
      <div class="flex flex-column gap-2">
        <span class="text-500 text-sm">{{ editingUser.email }}</span>
      </div>
      <div class="flex flex-column gap-2">
        <label for="edit-status" class="font-medium text-900">Status</label>
        <p-select id="edit-status" [(ngModel)]="editForm.status" name="editStatus" [options]="statusOptions" optionLabel="label" optionValue="value" styleClass="w-full" appendTo="body" />
      </div>
      @if (editingUser.role === 'DOCTOR') {
        <div class="flex flex-column gap-2">
          <label for="edit-spec" class="font-medium text-900">Specialization</label>
          <input id="edit-spec" pInputText type="text" [(ngModel)]="editForm.specialization" name="editSpec" class="w-full" />
        </div>
      }
      @if (editingUser.role === 'DOCTOR' || editingUser.role === 'RECEPTIONIST') {
        <div class="flex flex-column gap-2">
          <label for="edit-clinic" class="font-medium text-900">Clinic</label>
          <p-select id="edit-clinic" [(ngModel)]="editForm.clinicId" name="editClinicId" [options]="clinics" optionLabel="name" optionValue="_id" placeholder="Select clinic" styleClass="w-full" appendTo="body" />
        </div>
      }
      @if (editError) {
        <p-message severity="error" [text]="editError" styleClass="w-full"></p-message>
      }
    </form>
  }
  <ng-template pTemplate="footer">
    <p-button label="Cancel" severity="secondary" (onClick)="showEditForm = false; editingUser = null" styleClass="p-button-outlined" [disabled]="editSubmitting"></p-button>
    <p-button label="Save" icon="pi pi-check" (onClick)="updateUser()" [loading]="editSubmitting" [disabled]="editSubmitting"></p-button>
  </ng-template>
</p-dialog>
