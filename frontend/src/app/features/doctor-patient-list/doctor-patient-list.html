<div class="flex flex-column gap-4">
  <h1 class="m-0 text-2xl font-semibold text-900">
    <i class="pi pi-id-card mr-2 page-heading-icon"></i>My Patients
  </h1>
  <p class="text-600 m-0">Your assigned patients. Filter by status (VIS_A / VIS_B).</p>
  <p-card styleClass="shadow-2 border-round-lg">
    <div class="flex flex-column gap-3">
      <div class="flex flex-wrap gap-3 align-items-end">
        <div class="flex flex-column gap-2 patient-search-wrap" style="min-width: 16rem; max-width: 22rem;">
          <label for="patient-search" class="font-medium text-900">Search</label>
          <div class="p-input-icon-left patient-search-input-wrap">
            <i class="pi pi-search"></i>
            <input
              id="patient-search"
              pInputText
              type="text"
              placeholder="Search by name or email"
              [(ngModel)]="search"
              (input)="onSearchInput()"
              class="w-full"
            />
          </div>
        </div>
        <div class="flex flex-column gap-2" style="min-width: 10rem;">
          <label for="patient-status" class="font-medium text-900">Status</label>
          <p-select
            id="patient-status"
            [(ngModel)]="visibilityFilter"
            [options]="statusOptions"
            optionLabel="label"
            optionValue="value"
            placeholder="All"
            styleClass="w-full"
            (onChange)="onVisibilityFilterChange()"
          />
        </div>
      </div>
      @if (loading && !hasLoadedOnce) {
        <div class="flex align-items-center justify-content-center py-8">
          <i class="pi pi-spin pi-spinner text-4xl text-primary"></i>
        </div>
      } @else if (hasLoadedOnce && total === 0) {
        <div class="flex flex-column align-items-center justify-content-center py-8 text-600">
          <i class="pi pi-inbox text-4xl mb-2"></i>
          <p class="m-0 font-medium">No patients found.</p>
          <p class="m-0 text-sm mt-1">Try changing filters or search.</p>
        </div>
      } @else {
        <p-table
          [value]="patients"
          [lazy]="true"
          (onLazyLoad)="onLazyLoad($event)"
          [loading]="loading"
          [paginator]="true"
          [rows]="limit"
          [first]="first"
          [totalRecords]="total"
          [rowsPerPageOptions]="[10, 25, 50]"
          [showCurrentPageReport]="true"
          currentPageReportTemplate="Showing {{ first }} to {{ last }} of {{ totalRecords }} patients"
          styleClass="p-datatable-sm p-datatable-striped"
          [tableStyle]="{ 'min-width': '50rem' }"
          showGridlines
        >
          <ng-template pTemplate="header">
            <tr>
              <th style="width: 4rem;">S.No</th>
              <th>Name</th>
              <th>DOB</th>
              <th>Email</th>
              <th>Primary Doctor</th>
              <th>Visibility</th>
              <th>Registered by</th>
              <th>VIS_A / VIS_B records</th>
              <th style="width: 6rem;">Actions</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-row let-rowIndex="rowIndex">
            <tr>
              <td>{{ first + rowIndex + 1 }}</td>
              <td>{{ row.firstName }} {{ row.lastName }}</td>
              <td>{{ row.dob | date : 'shortDate' }}</td>
              <td>{{ row.contactEmail || '—' }}</td>
              <td>{{ row.primaryDoctorId?.name || '—' }}</td>
              <td>
                <span class="inline-flex align-items-center gap-1">
                  <i [class]="row.patientVisibility === 'VIS_B' ? 'pi pi-lock' : 'pi pi-globe'"></i>
                  {{ row.patientVisibility }}
                </span>
              </td>
              <td>{{ row.createdBy?.name || '—' }}</td>
              <td>{{ row.visACount ?? 0 }} / {{ row.visBCount ?? 0 }}</td>
              <td>
                <a [routerLink]="['/doctor/patients', row._id]" class="no-underline" pTooltip="View">
                  <p-button icon="pi pi-eye" styleClass="p-button-text p-button-sm"></p-button>
                </a>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="9" class="text-center py-4 text-600">No patients found.</td>
            </tr>
          </ng-template>
        </p-table>
      }
    </div>
  </p-card>
</div>
